#37
==

파일을 올릴 수 있으며 tmp-숫자 라는 파일들이 올라와져있음을 볼 수 있다.

![](https://postfiles.pstatic.net/MjAyMDAxMTdfNiAg/MDAxNTc5MjU1NjI2MTA4._M3Zlsb07uYlMkEZT9Nmaq-x8Vp-MjP_Fmdc-PBkISwg.H9q25WVZhWglOGRMO9QabDMIyEJymQZ3ZREsZymxJsAg.JPEG.rlaeoghks823/K-056.jpg?type=w773)

더 자세한 상황을 알기 위해 소스 코드를 살펴보았다.

```
<?php
  include "../../config.php";
  if($_GET['view_source']) view_source();
?><html>
<head>
<title>Challenge 37</title>
</head>
<body>
<?php
  $db = dbconnect();
  $query = "select flag from challenge where idx=37";
  $flag = mysqli_fetch_array(mysqli_query($db,$query))['flag'];
  $time = time();

  $p = fopen("./tmp/tmp-{$time}","w");
  fwrite($p,"127.0.0.1");
  fclose($p);

  $file_nm = $_FILES['upfile']['name'];
  $file_nm = str_replace("<","",$file_nm);
  $file_nm = str_replace(">","",$file_nm);
  $file_nm = str_replace(".","",$file_nm);
  $file_nm = str_replace("/","",$file_nm);
  $file_nm = str_replace(" ","",$file_nm);

  if($file_nm){
    $p = fopen("./tmp/{$file_nm}","w");
    fwrite($p,$_SERVER['REMOTE_ADDR']);
    fclose($p);
  }

  echo "<pre>";
  $dirList = scandir("./tmp");
  for($i=0;$i<=count($dirList);$i++){
    echo "{$dirList[$i]}\n";
  }
  echo "</pre>";

  $host = file_get_contents("tmp/tmp-{$time}");

  $request = "GET /?{$flag} HTTP/1.0\r\n";
  $request .= "Host: {$host}\r\n";
  $request .= "\r\n";

  $socket = fsockopen($host,7777,$errstr,$errno,1);
  fputs($socket,$request);
  fclose($socket);

  if(count($dirList) > 20) system("rm -rf ./tmp/*");
?>
<form method=post enctype="multipart/form-data" action=index.php>
<input type=file name=upfile><input type=submit>
</form>
<a href=./?view_source=1>view-source</a>
</body>
</html>
```

time 함수를 보면 tmp-숫자라는 파일에서 숫자가 현재 시각을 의미한다는 것을 알 수 있다.

또한 tmp 파일을 만들며 파일에 127.0.0.1를 저장함을 알 수 있다.

만약 사용자가 파일을 올리게 되면 `$_FILES['upfile']['name']`를 통해 post 방식으로 파일을 업로드 해준다.  
그리고 이 파일에 사용자의 IP주소를 적어둔다.

`file_get_contents` 함수를 통해 `tmp-{$time}`값을 `host`라는 변수에 저장하고 IP는 `host`값 포트는 7777로 통신을 연다.

즉 코드를 통해 이 문제를 해결하는 방법은
netcat을 통해 포트 7777로 통신을 연 다음 현재 시각을 이름으로 한 파일을 서버에 올려주면 된다는 것이다. 

그러면 `tmp-{$time}`값은 `127.0.0.1`에서 사용자의 IP 주소로 바뀌게 되고 제대로 통신이 연결되어 flag 값이 출력 될 것이다.

```
C:\netcat>nc -l -p 7777
GET /?FLAG{well...is_it_funny?_i_dont_think_so...} HTTP/1.0
Host: 
```
